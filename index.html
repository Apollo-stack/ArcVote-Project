<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcVote - Vota√ß√£o Descentralizada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link  href="css/style.css" rel="stylesheet">
</head>
<body>

    <div class="container">
        <h1>ü™ô ArcVote System</h1>
        <p>Vote na sua moeda favorita na rede Arc Testnet</p>
        
        <button id="connectBtn" class="btn-connect" onclick="conectarCarteira()">Conectar MetaMask</button>
        <p id="walletAddress" style="font-size: 12px; color: #252525;">Carteira n√£o conectada</p>

        <div id="candidatesList">
            <p>Conecte sua carteira para ver os candidatos...</p>
        </div>

        <div id="status"></div>
    </div>

    <script>
        // CONFIGURA√á√ÉO 
        
        const CONTRACT_ADDRESS = "0xd8b934580fcE35a11B58C6D73aDeE468a2833fa8"; 
        
        const ABI = [
            "function votar(uint256 _candidatoIndex) public",
            "function candidatos(uint256) view returns (string name, uint256 voteCount)",
            "function jaVotou(address) view returns (bool)",
            "function contarCandidatos() view returns (uint256)", // <--- ADICIONAMOS ISSO
            "event votoComputado(address eleitor, string nomeCandidato)"
        ];

        // Vari√°veis globais
        let provider, signer, contract;

        // --- FUN√á√ïES ---

        async function carregarCandidatos() {
            const listaDiv = document.getElementById("candidatesList");
            listaDiv.innerHTML = "<div class='loader' style='display:inline-block'></div> Carregando dados...";

            try {
                // Pergunta ao contrato: "Quantos candidatos tem na lista?"
                const quantidadeBigInt = await contract.contarCandidatos();
                const quantidade = Number(quantidadeBigInt); // Converte para n√∫mero normal

                let html = "";
                let totalVotosGeral = 0; // Vari√°vel para somar tudo

                // O LOOP FLEX√çVEL: Agora vai de 0 at√© a "quantidade" exata
                for(let i = 0; i < quantidade; i++) {
                    const candidato = await contract.candidatos(i);
                    
                    const nome = candidato[0];
                    const votos = Number(candidato[1]); // Converte votos para n√∫mero JS

                    // Soma ao total geral
                    totalVotosGeral += votos;
                    
                    html += `
                        <div class="candidate-card">
                            <div>
                                <strong>${nome}</strong>
                            </div>
                            <div>
                                <span style="font-size: 1.2em; margin-right: 15px;">${votos} votos</span>
                                <button class="btn-vote" onclick="votar(${i})">Votar</button>
                            </div>
                        </div>
                    `;
                }
                
                // Adiciona o Total de Votos no final da lista HTML
                html += `
                    <div style="margin-top: 20px; padding: 15px; background-color: #fff; border-radius: 8px; font-weight: bold; color: #333;">
                        üìä Total de Votos na Rede: <span style="font-size: 1.4em; color: #4CAF50;">${totalVotosGeral}</span>
                    </div>
                `;
                
                listaDiv.innerHTML = html;

            } catch (error) {
                listaDiv.innerHTML = "<p style='color:red'>Erro ao ler contrato. Verifique rede e endere√ßo.</p>";
                console.error(error);
            }
        }

        async function votar(index) {
            const statusDiv = document.getElementById("status");
            statusDiv.innerHTML = "<div class='loader' style='display:inline-block'></div> Enviando transa√ß√£o para a Arc... (Confirme na MetaMask)";
            
            try {
                // Chama a fun√ß√£o votar do contrato
                const tx = await contract.votar(index);
                
                statusDiv.innerHTML = "Transa√ß√£o enviada! Aguardando confirma√ß√£o da rede...";
                
                // Espera a transa√ß√£o ser minerada
                await tx.wait();
                
                statusDiv.innerHTML = "<span style='color:green'>‚úÖ Voto confirmado com sucesso!</span>";
                
                // Recarrega a lista para mostrar o novo voto
                carregarCandidatos();

            } catch (error) {
                console.error(error);
                // Tratamento de erro simples para quando o usu√°rio j√° votou
                if(error.message.includes("Voce ja votou")) {
                    statusDiv.innerHTML = "<span style='color:red'> Voc√™ j√° gastou seu voto!</span>";
                } else {
                    statusDiv.innerHTML = "<span style='color:red'>Erro ao votar. (Veja o console F12)</span>";
                }
            }
        }
    </script>
</body>
</html>