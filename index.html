<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcVote - Decentralized Voting</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link  rel="stylesheet" href="css/style.css" >
</head>

<body>

    <div class="container">
        <h1>ü™ô ArcVote System</h1>
        <p>Vote for your favorite coin on the Arc Testnet network.</p>
        
        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect MetaMask</button>
        <p id="walletAddress" style="font-size: 12px; color: #252525;">Wallet not connected</p>

        <div id="candidatesList">
            <p>Connect your wallet to view the candidates...</p>
        </div>

        <div id="status"></div>
    </div>

    <script>
        //configura√ß√µes 
        const CONTRACT_ADDRESS = "0x0563aa9E371daeEf083d82b30E997CdAed2E467B"; 
        
        const ABI = [
            "function vote(uint256 _candidateIndex) public",
            "function candidates(uint256) view returns (string name, uint256 voteCount)",
            "function hasVoted(address) view returns (bool)",
            "function getCandidatesCount() view returns (uint256)", 
            "event VoteConfirmed(address voter, string candidateName)"
        ];

        //vari√°veis globais
        let provider, signer, contract;

        //fun√ß√µes
        async function connectWallet() {
            if (window.ethereum) {
                try {

                    //permiss√£o para acessar a MetaMask
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    //configura a conex√£o 
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    const address = await signer.getAddress();
                    
                    <div class="header-buttons">
                        <button id="connectBtn" class="btn-connect" onclick="connectWallet()">Connect MetaMask</button>
    
                        <button id="disconnectBtn" class="btn-disconnect" onclick="disconnectWallet()">Disconnect</button>
                    </div>

                    document.getElementById("walletAddress").innerText = "Connected as: " + address.substring(0,6) + "..." + address.substring(38);
                    
                    //conecta com o contrato
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    loadCandidates();

                } catch (error) {
                    console.error(error);
                    alert("Erro connecting: " + error.message);
                }
            } else {
                alert("Install MetaMask!");
            }
        }

        function disconnectWallet() {
            window.location.reload();
        }


        async function loadCandidates() {
            const listaDiv = document.getElementById("candidatesList");
            listaDiv.innerHTML = "<div class='loader' style='display:inline-block'></div> Loading data...";

            try {

                //verifica quantos candidatos tem na lista
                const amountBigInt = await contract.getCandidatesCount();
                const amount = Number(amountBigInt); //converte para n√∫mero normal

                let html = "";
                let totalVotesOverall = 0; 
                
                for(let i = 0; i < amount; i++) {
                    const candidate = await contract.candidates(i);
                    
                    const name = candidate[0];
                    const votes = Number(candidate[1]); //converte votos para n√∫mero JS

                    
                    totalVotesOverall += votes;
                    
                    html += `
                        <div class="candidate-card">
                            <div>
                                <strong>${name}</strong>
                            </div>
                            <div>
                                <span style="font-size: 1.2em; margin-right: 15px;">${votes} votes</span>
                                <button class="btn-vote" onclick="vote(${i})">Vote</button>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="total-card">
                        <span>üìä Total Votes on the Network:</span>
                        <span class="total-number">${totalVotesOverall}</span>
                    </div>
                `;
                
                listaDiv.innerHTML = html;

            } catch (error) {
                listaDiv.innerHTML = "<p style='color:red'>Error reading contract. Check network and address..</p>";
                console.error(error);
            }
        }

        async function vote(index) {
            const statusDiv = document.getElementById("status");
            statusDiv.innerHTML = "<div class='loader' style='display:inline-block'></div> Sending transaction to Arc... (Confirm in MetaMask)";
            
            try {
                //chama a fun√ß√£o vote do contrato
                const tx = await contract.vote(index);
                
                statusDiv.innerHTML = "Transaction sent! Awaiting network confirmation...";
                
                //espera a transa√ß√£o ser minerada
                await tx.wait();
                
                statusDiv.innerHTML = "<span style='color:green'>‚úÖ Vote successfully confirmed.!</span>";
                
                //recarrega a lista para mostrar o novo voto
                loadCandidates();

            } catch (error) {
                console.error(error);
                
                if(error.message.includes("You have already voted!")) {
                    statusDiv.innerHTML = "<span style='color:red'> You have already used your vote!</span>";
                } else {
                    statusDiv.innerHTML = "<span style='color:red'>Voting error. (See F12 console)</span>";
                }
            }
        }
    </script>
</body>
</html>